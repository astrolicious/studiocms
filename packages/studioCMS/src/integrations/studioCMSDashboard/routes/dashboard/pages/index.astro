---
import { Layout, WebVitalPanel } from 'studiocms-dashboard:components';
import Config from 'virtual:studiocms/config';
import { authHelper, type Locals } from 'studiocms:helpers';
import { StudioCMSRoutes } from 'studiocms-dashboard:routeMap';
import { studioCMSSocials } from "../layouts/studiocms-socials";
import { getWebVitals } from 'studiocms-dashboard:web-vitals';
import { Divider, Card, Alert, Button, Icon, Details } from 'astrolace:components';
import { getSiteConfig } from 'studiocms-dashboard:contentHelper';
import BetaFeedback from '../components/BetaFeedback.astro';
import CrumbStack from '../components/CrumbStack.astro';

const { 
    mainLinks: {
        dashboardIndex
    },
} = StudioCMSRoutes;

const { github, discord } = studioCMSSocials;
const { dashboardConfig: { developerConfig } } = Config;
const contextConfig = await getSiteConfig();
const { permissionLevel } = await authHelper(Astro.locals as Locals);

// Get the web vitals
const webVitals = await getWebVitals();

// If the user is not logged in, redirect to the login page
if ( !developerConfig.testingAndDemoMode ) {
    if ( permissionLevel === "unknown" ) {
        console.log('User is not logged in. Redirecting to login page.');
        return Astro.redirect(StudioCMSRoutes.authLinks.loginURL);
    }
    if ( permissionLevel !== 'admin' && permissionLevel !== 'editor' ) {
        console.log('User is not an admin or editor. Redirecting to profile page.');
        return Astro.redirect(StudioCMSRoutes.mainLinks.userProfile);
    }
}

const pageTitle = `Dashboard | ${contextConfig.title}`;
---

<Layout 
    sideBarActiveItemID="dashboard" 
    title={pageTitle}
    description={contextConfig.description} >

    <CrumbStack items={[
        { href: dashboardIndex, text: 'Dashboard', prefix: 'columns-gap' }
    ]} />

    <div class="container">

        <h1 class="text-4xl font-bold py-8">Dashboard</h1>

        <Card class="w-full">
            <p>This is <strong>StudioCMS</strong> a free and open-source CMS built from the ground up by the Astro Community.</p>
        </Card>

        <Divider />

        <Alert variant="warning" open>
            <Icon slot="icon" name="exclamation-triangle" />
            <p>This project is <strong>Experimental</strong> and should not be used in production at this time.</p>
        </Alert>

        { webVitals.length > 0 && (
            <Divider />

            <Card class="w-full card-header">

                <Details>
                    <div slot="summary" class="flex flex-row gap-4 items-center">
                        <Icon slot="icon" name="check2-circle" class:list={"text-green-500 font-size-6"} />
                        <p>Web Vitals is <strong class="text-green">ENABLED</strong>! <strong>Performance Metrics</strong> are being collected.</p>
                    </div>
                    <WebVitalPanel webVitalData={webVitals} />
                </Details>

            </Card>
        )}

        <div class="mt-8 flex flex-wrap gap-4">
            <Button variant="warning" size="large" href={github} target="_blank" outline>
                <Icon slot="prefix" name="star" />
                <div>Star us on Github</div>
            </Button>
            <Button variant="primary" size="large" href={discord} target="_blank" outline>
                <Icon slot="prefix" name="discord" />
                Join the Community
            </Button>
            <BetaFeedback />
        </div>

    </div>
</Layout>