---
import Dashboard from '../layouts/Dashboard.astro';
import authHelper from '../utils/authhelper';
import type { Locals } from '../schemas/locals';
import Config from 'virtual:studiocms/config';

if (Config.includedIntegrations.useInoxSitemap) {
    import('sitemap-ext:config').then((sitemap) => {
        sitemap.default(false)
    })
}

const locals = Astro.locals as Locals;

const { 
    name, 
    username, 
    avatar, 
    githubURL, 
    permissionLevel, 
    currentUserSession 
} = await authHelper(locals);

function redirectToPath(path: string) {
	return Astro.redirect(import.meta.env.BASE_URL + path);
}

// If the user is not logged in, redirect to the login page
if ( permissionLevel === "unknown" ) {
    console.log('User is not logged in. Redirecting to login page.');
    return redirectToPath('dashboard/login');
}
---

<Dashboard title='User Profile'>
    <img src={avatar} alt={name} height="64px" width="64px">
    <p><bold>{username}</bold>'s Profile</p>

    <div>

        <p><bold>Display Name:</bold> {name}</p>
        <p><bold>Role:</bold> {permissionLevel.toUpperCase()}</p>
        <p><bold>GitHub:</bold> <a href={githubURL}>{username}</a> 
        { currentUserSession && (
            <p><bold>Session Expires:</bold> {new Date(currentUserSession.expiresAt).toLocaleString()} </p>
        ) } 
        </p>
    </div>
</Dashboard>

<style>
    .dash {
        padding: 2rem;
        border: 2px solid #ccc;
        border-radius: 5rem;
        background-color: #fff;
        margin: 2rem;
    }
    .dash-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-right: 4rem;
        padding-left: 4rem;
    }
    bold {
        font-weight: bold;
    }
    .font-small {
        font-size: 1rem;
    }
    form {
        display: flex;
        justify-content: flex-end;
    }
    button {
        padding: 1rem;
        background-color: rgb(202, 0, 0);
        font-weight: bold;
        color: #fff;
        border: none;
        border-radius: 99rem;
        cursor: pointer;
    }
</style>